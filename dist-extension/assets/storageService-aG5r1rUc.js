import{b as h,O as y,P as f,Q as D,V as _,x as m,n as b,g as U,h as w}from"./main-Bi0Ei0w3.js";const A=r=>{const t=r.split(","),s=t[0].match(/:(.*?);/);if(!s)return null;const e=s[1],a=atob(t[1]);let o=a.length;const n=new Uint8Array(o);for(;o--;)n[o]=a.charCodeAt(o);return new Blob([n],{type:e})},S=async(r,t)=>{const s=h.currentUser;if(!s)throw new Error("User must be authenticated for fallback upload.");const e=await s.getIdToken();let a,o="image/png";if(r instanceof Blob)o=r.type||"image/png",a=await new Promise((c,g)=>{const i=new FileReader;i.onloadend=()=>{const u=i.result;c(u.split(",")[1])},i.onerror=g,i.readAsDataURL(r)});else{const c=r instanceof Uint8Array?r:new Uint8Array(r);let g="";const i=c.byteLength;for(let u=0;u<i;u++)g+=String.fromCharCode(c[u]);a=btoa(g)}const d="https://us-west1-jastalk-firebase.cloudfunctions.net/uploadImageHttp";console.log(`[Upload Debug] Attempting server-side upload via: ${d}`);const l=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({image:a,path:t,mimeType:o})});if(!l.ok){const c=await l.text();throw console.error("[Upload Debug] Server-side upload failed response:",c),new Error(`Server-side upload failed (${l.status}): ${c}`)}const p=await l.json();return console.log("[Upload Debug] Server-side upload successful. URL:",p.downloadUrl),p.downloadUrl},L=async(r,t)=>{console.log("[Upload Debug] Starting upload..."),console.log(`[Upload Debug] Target Path: ${t}`);const s=h.currentUser;console.log(`[Upload Debug] Auth Status: ${s?`User ID: ${s.uid}`:"Unauthenticated"}`),!s&&t.includes("resume_photos")&&console.warn("[Upload Debug] WARNING: Uploading to a user-specific path (resume_photos) without an authenticated user.");try{const e=y(f,t);let a="image/png",o=0;r instanceof Blob?(a=r.type,o=r.size):o=r.byteLength;const n={contentType:a};console.log("[Upload Debug] Uploading bytes (Client SDK)...",{size:o,metadata:n});const d=await D(e,r,n);console.log("[Upload Debug] Upload successful. Snapshot:",d),console.log("[Upload Debug] Fetching download URL...");const l=await _(d.ref);return console.log("[Upload Debug] Download URL retrieved:",l),l}catch(e){if(console.error("[Upload Debug] Client-side Upload FAILED:",e),e.code==="storage/retry-limit-exceeded"||e.code==="storage/canceled"||e.message?.includes("network")||e.message?.includes("fetch")){console.warn("[Upload Debug] Detected network/CORS issue. Switching to Server-Side Fallback...");try{return await S(r,t)}catch(o){if(console.error("[Upload Debug] Server-Side Fallback ALSO FAILED:",o),t.includes("resume_photos"))try{await m(b(U,"system_alerts"),{error_message:`Fallback Failed: ${o.message}`,original_error:e.message,user_id:s?.uid||"anonymous",path:t,timestamp:w(),type:"upload_fallback_failure"})}catch{}throw o}}if(t.includes("resume_photos")){console.log('[Upload Debug] Path contains "resume_photos". Logging to system_alerts...');try{await m(b(U,"system_alerts"),{error_message:e.message||"Unknown upload error",user_id:s?.uid||"anonymous",path:t,timestamp:w(),type:"resume_upload_failure",raw_error:JSON.stringify(e,Object.getOwnPropertyNames(e))}),console.log("[Upload Debug] Error successfully logged to Firestore.")}catch(o){console.error("[Upload Debug] Failed to log error to Firestore:",o)}}else t.includes("blog_assets")&&console.error("[Upload Debug] Blog Asset Upload Error (Admin Console):",e);throw e}};export{A as d,L as u};
