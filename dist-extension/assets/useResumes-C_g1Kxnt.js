import{u as H,r as l,m as g,f as n,q as U,z as N,p as B,o as h,e as f,l as R,A as I,v as D,g as y,B as $,C as x,n as O,D as Y}from"./main-BEc7sVU2.js";const F=()=>{const{currentUser:e}=H(),[u,A]=l.useState([]),[L,E]=l.useState(!0);l.useEffect(()=>{if(!e?.uid){A([]),E(!1);return}E(!0);const s=g(n,"users",e.uid,"resumes"),t=U(s,N("updatedAt","desc")),r=B(t,i=>{const c=[],a=I();i.forEach(m=>{const o=m.data(),d={...a,...o,id:m.id,section:o.section||"resumes",personalDetails:{...a.personalDetails,...o.personalDetails||{}},websites:o.websites||[],skills:o.skills||[],employmentHistory:o.employmentHistory||[],education:o.education||[],languages:o.languages||[],updatedAt:o.updatedAt?.toDate?o.updatedAt.toDate().toISOString():o.updatedAt||new Date().toISOString()};c.push(d)}),A(c),E(!1)},i=>{console.error("Error fetching resumes:",i),E(!1)});return()=>r()},[e?.uid]);const w=l.useCallback(s=>u.find(t=>t.id===s),[u]),C=l.useCallback(()=>{h("/new")},[]),b=l.useCallback(async()=>{if(e)try{const s=f(n,"users",e.uid),r=(await R(s)).data(),c=r?.promotions?.isPremium===!0?999:r?.resumeLimit||2;if(u.length>=c)throw new Error("RESUME_LIMIT_REACHED");const a=I();if(e.displayName){const p=e.displayName.split(" ");a.personalDetails.firstName=p.shift()||"",a.personalDetails.lastName=p.join(" ")||""}e.email&&(a.personalDetails.email=e.email),e.photoURL&&(a.personalDetails.photo=e.photoURL),a.personalDetails.firstName&&(a.title=`${a.personalDetails.firstName}'s Resume`);const{id:m,...o}=a,d=await D(g(n,"users",e.uid,"resumes"),{...o,section:"resumes",updatedAt:y()});h(`/edit/${d.id}`)}catch(s){s.message==="RESUME_LIMIT_REACHED"?alert("You have reached your resume storage limit. Please upgrade your plan to create more resumes."):console.error("Error adding blank resume:",s)}},[e,u.length]),S=l.useCallback(async(s,t)=>{if(e)try{const r=f(n,"users",e.uid),c=(await R(r)).data(),m=c?.promotions?.isPremium===!0?999:c?.resumeLimit||2;if(u.length>=m)throw new Error("RESUME_LIMIT_REACHED");const d={title:t||"AI Generated Resume",templateId:"Modern",personalDetails:{...{jobTitle:"",photo:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",postalCode:"",country:""},...s.personalDetails},professionalSummary:s.professionalSummary||"",websites:s.websites||[],skills:s.skills||[],employmentHistory:s.employmentHistory||[],education:s.education||[],languages:s.languages||[],themeColor:"#000000",titleFont:"Montserrat",bodyFont:"Crimson Text",language:"English",section:"resumes"},p=await D(g(n,"users",e.uid,"resumes"),{...d,updatedAt:y()});h(`/edit/${p.id}`)}catch(r){r.message==="RESUME_LIMIT_REACHED"?alert("You have reached your resume storage limit. Please upgrade your plan to create more resumes."):console.error("Error adding AI resume:",r)}},[e,u.length]),M=l.useCallback(async s=>{if(e)try{const t=f(n,"users",e.uid),i=(await R(t)).data(),a=i?.promotions?.isPremium===!0?999:i?.resumeLimit||2;if(u.length>=a)throw new Error("RESUME_LIMIT_REACHED");const{id:m,...o}=s;await D(g(n,"users",e.uid,"resumes"),{...o,updatedAt:y()})}catch(t){t.message==="RESUME_LIMIT_REACHED"?alert("You have reached your resume storage limit. Please upgrade your plan to create more resumes."):console.error("Error saving AI resume:",t)}},[e,u.length]),P=l.useCallback(async(s,t)=>{if(e)try{const r=JSON.parse(JSON.stringify(t));delete r.id,delete r.updatedAt;const i=f(n,"users",e.uid,"resumes",s);await $(i,{...r,updatedAt:y()})}catch(r){console.error("Error updating resume:",r),r instanceof TypeError&&r.message.includes("circular structure")&&console.error("A circular reference was detected in the data being saved:",t)}},[e]),_=l.useCallback(async s=>{if(!e)return;const t=f(n,"users",e.uid,"resumes",s);try{await x(t),u.length===1?h("/new"):h("/")}catch(r){console.error("Error deleting resume:",r)}},[e,u.length]),k=l.useCallback(async s=>{if(!e)return;const t=w(s);if(t)try{const r=f(n,"users",e.uid),c=(await R(r)).data();let a=c?.resumeLimit||2;const m=c?.plan,o=c?.promotions?.isPremium===!0;if(m==="pro_monthly"?a=9999:m==="pro_sprint"?a=100:o&&(a=Math.max(a,9999)),u.length>=a)throw new Error("RESUME_LIMIT_REACHED");const{id:d,...p}=t,v=await D(g(n,"users",e.uid,"resumes"),{...p,title:`${t.title} (Copy)`,updatedAt:y()});h(`/edit/${v.id}`)}catch(r){r.message==="RESUME_LIMIT_REACHED"?alert("You have reached your resume storage limit. Please upgrade your plan to create more resumes."):console.error("Error duplicating resume:",r)}},[e,w,u.length]),T=l.useCallback(async()=>{if(e)try{const s=g(n,"users",e.uid,"resumes"),t=await O(s),r=Y(n);t.docs.forEach(i=>{r.delete(i.ref)}),await r.commit()}catch(s){throw console.error("Error deleting all resumes:",s),s}},[e]);return{resumes:u,isLoading:L,getResumeById:w,addResume:C,updateResume:P,deleteResume:_,duplicateResume:k,addAIGeneratedResume:S,saveAIGeneratedResume:M,addBlankResume:b,deleteAllResumes:T}};export{F as u};
