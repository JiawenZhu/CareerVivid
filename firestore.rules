rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // üõ°Ô∏è ADMIN CHECK (Robust & Fail-Safe)
    // ---------------------------------------------------------
    function isAdmin() {
      return request.auth != null && (
        // 1. Email Bypass
        (request.auth.token.email == 'evan@careervivid.app' || request.auth.token.email == 'evan@jastalk.com') ||
        // 2. Role Check
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'academic_partner', 'super_admin']
        )
      );
    }

    function isBusinessPartner() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'business_partner' ||
          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('roles', []) != null &&
           'business_partner' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('roles', []))
        );
    }

    // ---------------------------------------------------------
    // üë§ CORE USER DATA (Recursive - Covers EVERYTHING)
    // ---------------------------------------------------------
    match /users/{userId} {
      // Users read their own data; admins read all; business partners can read
      // applicant profiles (name & email only ‚Äî needed for the HR dashboard).
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isBusinessPartner());
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());

      // Resumes specifically can be read by business partners so they can view applicants
      match /resumes/{resumeId} {
        allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isBusinessPartner());
        allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());

        // üí¨ Comments on Resumes
        match /comments/{commentId} {
          allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isBusinessPartner())
                      || get(/databases/$(database)/documents/users/$(userId)/resumes/$(resumeId)).data.shareConfig.enabled == true;
          allow delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
          allow create, update: if request.auth != null && (
            request.auth.uid == userId || isAdmin() ||
            get(/databases/$(database)/documents/users/$(userId)/resumes/$(resumeId)).data.shareConfig.enabled == true
          );
        }

        // üéØ Annotations on Resumes
        match /annotations/{annotationId} {
          allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isBusinessPartner())
                      || get(/databases/$(database)/documents/users/$(userId)/resumes/$(resumeId)).data.shareConfig.enabled == true;
          allow delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
          allow create, update: if request.auth != null && (
            request.auth.uid == userId || isAdmin() ||
            get(/databases/$(database)/documents/users/$(userId)/resumes/$(resumeId)).data.shareConfig.enabled == true
          );
        }
      }

      // Recursive match for all other subcollections (settings, referralStats, etc.)
      match /{allChildren=**} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // ---------------------------------------------------------
    // üéüÔ∏è REFERRAL CODES (Root Collection)
    // ---------------------------------------------------------
    match /referralCodes/{code} {
      // Anyone logged in can read codes (to validate them).
      // Admins can read everything.
      allow read: if request.auth != null || isAdmin();
      
      // Creation/Updates:
      // 1. Admins: Always allowed.
      // 2. Users: Can create/update if the code document belongs to them (userId field matches).
      allow write: if isAdmin() || (request.auth != null && (resource == null || resource.data.userId == request.auth.uid));
    }

    // ---------------------------------------------------------
    // üíº CLIENT PORTAL (Root Collection)
    // ---------------------------------------------------------
    match /client_projects/{projectId} {
      allow read: if (request.auth != null && resource.data.ownerId == request.auth.uid) || isAdmin();
      allow write: if isAdmin(); 
      allow list: if isAdmin();

      match /tasks/{taskId} {
        allow read: if (request.auth != null && get(/databases/$(database)/documents/client_projects/$(projectId)).data.ownerId == request.auth.uid) || isAdmin();
        allow write: if isAdmin(); 
        
        allow update: if (request.auth != null && get(/databases/$(database)/documents/client_projects/$(projectId)).data.ownerId == request.auth.uid)
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['comments']);
      }
    }
    // ---------------------------------------------------------
    // üåê PUBLIC PORTFOLIOS (Public Read, Owner/Admin Write)
    // ---------------------------------------------------------
    match /public_portfolios/{portfolioId} {
      allow read: if true;
      allow create, update: if isAdmin() || (request.auth != null && request.resource.data.userId == request.auth.uid);
      allow delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // ---------------------------------------------------------
    // üé® USER THEMES (Public Read, Owner Write)
    // ---------------------------------------------------------
    match /user_themes/{themeId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ---------------------------------------------------------
    // üì∞ BLOG POSTS (Public Read)
    // ---------------------------------------------------------
    match /blog_posts/{postId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    // ---------------------------------------------------------
    // üì¨ CONTACT MESSAGES (Public Create, Admin Manage)
    // ---------------------------------------------------------
    match /contact_messages/{messageId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // üó£Ô∏è FEEDBACK (Public Create, Admin Manage)
    // ---------------------------------------------------------
    match /feedback/{feedbackId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // ‚ö†Ô∏è ERROR REPORTS (Public Create, Admin Manage)
    // ---------------------------------------------------------
    match /error_reports/{errorId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // ü§ù PARTNER APPLICATIONS (Public Create, Admin Manage)
    // ---------------------------------------------------------
    match /partner_applications/{applicationId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // ‚öôÔ∏è SYSTEM SETTINGS (Public Read, Admin Manage)
    // ---------------------------------------------------------
    match /system_settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ---------------------------------------------------------
    // üìä USAGE LOGS (Public Create, Admin Manage)
    // ---------------------------------------------------------
    match /usage_logs/{logId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // üìà ANALYTICS (Public Update, Admin Manage)
    // ---------------------------------------------------------
    match /analytics/{docId} {
      allow create, update: if true;
      allow read, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // üìß EMAIL TEMPLATES (Admin Manage)
    // ---------------------------------------------------------
    match /email_templates/{templateId} {
      allow read, write: if isAdmin();
    }

    // ---------------------------------------------------------
    // üì® MAIL (Admin Send)
    // ---------------------------------------------------------
    match /mail/{mailId} {
      allow create: if isAdmin();
      allow read, update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // üìù COMMUNITY POSTS (canonical collection)
    // ---------------------------------------------------------
    match /community_posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null && (request.auth.uid == resource.data.authorId || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['metrics', 'updatedAt']));
      allow delete: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.authorId);
    }

    // Legacy 'posts' collection ‚Äî kept for backward compatibility
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null && (request.auth.uid == resource.data.authorId || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['metrics', 'updatedAt']));
      allow delete: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.authorId);
    }

    match /community_post_likes/{likeId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    match /post_likes/{likeId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    match /community_post_comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.authorId);
    }


    match /post_comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.authorId);
    }

    // ---------------------------------------------------------
    // üñåÔ∏è WHITEBOARDS (Excalidraw)
    // ---------------------------------------------------------
    match /whiteboards/{whiteboardId} {
      // Owner: full access
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Public read: anyone can view if the whiteboard is marked public (for community feed links)
      allow read: if resource.data.isPublic == true;
    }

    // ---------------------------------------------------------
    // üíº JOB POSTINGS (B2B Business Partner)
    // ---------------------------------------------------------
    match /jobPostings/{jobId} {
      // Anyone can read published jobs (public job board).
      allow read: if resource.data.status == 'published' || resource.data.get('status', '') == 'published';
      // Business partners (HR) can read ALL their own job postings (incl. drafts).
      allow read: if request.auth != null && resource.data.hrUserId == request.auth.uid;
      // Admins can read everything.
      allow read: if isAdmin();
      // Only the owning business partner (or admin) can create/update/delete.
      allow create: if isBusinessPartner() || isAdmin();
      allow update, delete: if (isBusinessPartner() && resource.data.hrUserId == request.auth.uid) || isAdmin();
    }

    // ---------------------------------------------------------
    // üìã JOB APPLICATIONS (B2B Business Partner)
    // ---------------------------------------------------------
    match /jobApplications/{appId} {
      // Applicant can read/edit/delete their own application.
      allow read, update, delete: if request.auth != null && resource.data.applicantUserId == request.auth.uid;
      // Applicant can submit new application.
      allow create: if request.auth != null && request.resource.data.applicantUserId == request.auth.uid;
      // Business partners can read applications for jobs they own.
      allow read: if isBusinessPartner() &&
        exists(/databases/$(database)/documents/jobPostings/$(resource.data.jobPostingId)) &&
        get(/databases/$(database)/documents/jobPostings/$(resource.data.jobPostingId)).data.hrUserId == request.auth.uid;
      // Business partners can update status fields on applications for their jobs.
      allow update: if isBusinessPartner() &&
        exists(/databases/$(database)/documents/jobPostings/$(resource.data.jobPostingId)) &&
        get(/databases/$(database)/documents/jobPostings/$(resource.data.jobPostingId)).data.hrUserId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'statusHistory', 'hrNotes', 'rating', 'matchAnalysis', 'lastUpdated']);
      // Admins can do everything.
      allow read, write: if isAdmin();
    }

    // ---------------------------------------------------------
    // üè¢ COMPANY PROFILES (B2B Business Partner)
    // ---------------------------------------------------------
    match /companyProfiles/{profileId} {
      // Public read for the job board embed widget.
      allow read: if true;
      // Business partner can create/update their own profile.
      allow create: if (isBusinessPartner() || isAdmin()) && request.resource.data.hrUserId == request.auth.uid;
      allow update, delete: if (isBusinessPartner() && resource.data.hrUserId == request.auth.uid) || isAdmin();
    }
  }
}
